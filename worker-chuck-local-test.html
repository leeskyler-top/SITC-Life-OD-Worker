<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Cloudflare Worker ä¸­è½¬ä¸Šä¼ </title>
</head>
<body>
<h2>ä¸Šä¼ å›¾ç‰‡åˆ° OneDriveï¼ˆCloudflare Worker ä¸­è½¬ï¼‰</h2>

<h3>HTTP API</h3>
<textarea id="http-api" style="width: 80%; height: 2em;">https://ä½ çš„workeråœ°å€</textarea>
<br><br>

<h3>JWT Token</h3>
<textarea id="jwt-token" style="width: 80%; height: 4em;"></textarea>
<br><br>

<input type="file" id="fileInput" accept="image/*">
<br><br>
<button onclick="startUpload()">å¼€å§‹ä¸Šä¼ </button>
<pre id="log"></pre>
<br><br>

<h3>Download ID</h3>
<input id="download-id"/>
<button id="button-test">Download Test</button>

<script>
	function log(msg) {
		document.getElementById('log').textContent += msg + '\n';
	}

	async function startUpload() {
		const file = document.getElementById('fileInput').files[0];
		const workerBaseUrl = document.getElementById("http-api").value.trim();
		const userJwt = document.getElementById("jwt-token").value.trim();

		if (!file) return log('âŒ è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
		if (!workerBaseUrl || !userJwt) return log('âŒ API åœ°å€æˆ– JWT ç¼ºå¤±');

		log(`âœ… é€‰æ‹©æ–‡ä»¶ï¼š${file.name} (${file.size} bytes)`);

		// åˆ›å»ºä¸Šä¼ ä¼šè¯
		const sessionRes = await fetch(`${workerBaseUrl}/upload-session`, {
			method: 'POST',
			headers: {
				'Authorization': `Bearer ${userJwt}`,
				'Content-Type': 'application/json'
			},
			body: JSON.stringify({
				file_name: file.name,
				file_size: file.size
			})
		});

		const sessionData = await sessionRes.json();
		if (sessionData.status !== 'success') {
			log('âŒ åˆ›å»ºä¸Šä¼ ä¼šè¯å¤±è´¥: ' + sessionData.msg);
			return;
		}

		const { uploadId, guid } = sessionData.data;
		log('âœ… ä¸Šä¼ ä¼šè¯åˆ›å»ºæˆåŠŸ');
		log('ğŸ“¦ å¼€å§‹ä¸Šä¼ åˆ†ç‰‡...');

		const chunkSize = 80 * 1024 * 1024; // 80MB
		let uploaded = 0;
		while (uploaded < file.size) {
			const end = Math.min(uploaded + chunkSize, file.size);
			const chunk = file.slice(uploaded, end);
			const contentRange = `bytes ${uploaded}-${end - 1}/${file.size}`;

			const res = await fetch(`${workerBaseUrl}/upload-chunk`, {
				method: 'POST',
				headers: {
					'Authorization': `Bearer ${userJwt}`,
					'X-Upload-Id': uploadId,
					'X-Upload-Guid': guid,
					'X-Content-Range': contentRange,
					'Content-Length': chunk.size
				},
				body: chunk
			});

			const json = await res.json();
			if (json.status === 'success' && json.data?.url) {
				log('ğŸ‰ ä¸Šä¼ å®Œæˆï¼Œæ–‡ä»¶åœ°å€ï¼š' + json.data.url);
			}
			if (json.status !== 'success') {
				log(`âŒ ä¸Šä¼ å¤±è´¥ (${contentRange}): ${json.msg}`);
				return;
			}

			log(`âœ… åˆ†ç‰‡ä¸Šä¼ æˆåŠŸ: ${contentRange}`);
			uploaded = end;
		}

		log('ğŸ‰ æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼');
	}

	document.getElementById('button-test').addEventListener('click', async function () {
		const workerBaseUrl = document.getElementById("http-api").value.trim();
		const userJwt = document.getElementById("jwt-token").value.trim();
		const downloadId = document.getElementById('download-id').value.trim();

		if (!downloadId) {
			log('âŒ è¯·è¾“å…¥ Download ID');
			return;
		}

		log(`â³ æ­£åœ¨ä¸‹è½½æ–‡ä»¶ (ID: ${downloadId})...`);
		const res = await fetch(`${workerBaseUrl}/download/${downloadId}`, {
			headers: {
				'Authorization': `Bearer ${userJwt}`
			}
		});

		if (!res.ok) {
			const err = await res.json().catch(() => ({}));
			log(`âŒ ä¸‹è½½å¤±è´¥: ${err.msg || res.statusText}`);
			return;
		}

		const blob = await res.blob();
		const disposition = res.headers.get('Content-Disposition');
		let filename = downloadId;
		if (disposition) {
			const match = disposition.match(/filename="?([^"]+)"?/);
			if (match) filename = match[1];
		}

		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = filename;
		document.body.appendChild(a);
		a.click();
		URL.revokeObjectURL(url);
		a.remove();

		log(`âœ… ä¸‹è½½å®Œæˆ: ${filename}`);
	});
</script>
</body>
</html>
