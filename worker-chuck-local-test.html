<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cloudflare Worker ä¸­è½¬ä¸Šä¼ </title>
</head>
<body>
<h2>ä¸Šä¼ å›¾ç‰‡åˆ° OneDriveï¼ˆCloudflare Worker ä¸­è½¬ï¼‰</h2>
<h3>HTTP API</h3>
<textarea id="http-api"></textarea>
<br><br>
<h3>JWT Token</h3>
<textarea id="jwt-token"></textarea>
<br><br>
<input type="file" id="fileInput" accept="image/*">
<br><br>
<button onclick="startUpload()">å¼€å§‹ä¸Šä¼ </button>
<pre id="log"></pre>
<br><br>
<h3>Download ID</h3>
<input id="download-id"/>
<button id="button-test">Download Test</button>


<script>
    function log(msg) {
        document.getElementById('log').textContent += msg + '\n';
    }

    async function startUpload() {
        const file = document.getElementById('fileInput').files[0];
        const workerBaseUrl = document.querySelector("#http-api").value;
        const userJwt = document.querySelector("#jwt-token").value;
        console.log(userJwt);
        if (!file) {
            log('âŒ è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
            return;
        }

        log(`âœ… é€‰æ‹©æ–‡ä»¶ï¼š${file.name} (${file.size} bytes)`);

        // 1. åˆ›å»ºä¸Šä¼ ä¼šè¯
        const sessionRes = await fetch(`${workerBaseUrl}/upload-session`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${userJwt}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                file_name: file.name,
                file_size: file.size
            })
        });

        const sessionData = await sessionRes.json();
        if (sessionData.status !== 'success') {
            log('âŒ åˆ›å»ºä¸Šä¼ ä¼šè¯å¤±è´¥: ' + sessionData.msg);
            return;
        }

        const uploadUrl = sessionData.data.uploadUrl;
        log('âœ… åˆ›å»ºä¸Šä¼ ä¼šè¯æˆåŠŸ');
        log('ğŸ“¦ å¼€å§‹ä¸Šä¼ ...');

        // 2. åˆ†ç‰‡ä¸Šä¼ 
        const chunkSize = 40960 * 1024; // æ¯å— 80MB
        const totalSize = file.size;
        let uploaded = 0;

        while (uploaded < totalSize) {
            const end = Math.min(uploaded + chunkSize, totalSize);
            const chunk = file.slice(uploaded, end);
            const contentRange = `bytes ${uploaded}-${end - 1}/${totalSize}`;

            const chunkRes = await fetch(`${workerBaseUrl}/upload-chunk`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${userJwt}`,
                    'X-Content-Range': contentRange,
                    'X-Upload-Url': uploadUrl,
                    'Content-Length': chunk.size
                },
                body: chunk
            });

            const json = await chunkRes.json();
            if (json.status !== 'success') {
                log(`âŒ ä¸Šä¼ å¤±è´¥ at ${contentRange}: ${json.msg}`);
                return;
            }

            log(`âœ… ä¸Šä¼ åˆ†ç‰‡æˆåŠŸï¼š${contentRange}`);
            uploaded = end;
        }

        log('ğŸ‰ æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼');
    }

    document.getElementById('button-test').addEventListener('click', async function () {
        const workerBaseUrl = document.querySelector("#http-api").value;
        const userJwt = document.querySelector("#jwt-token").value;
        const downloadId = document.getElementById('download-id').value;

        if (!downloadId) {
            log('âŒ è¯·è¾“å…¥ Download ID');
            return;
        }

        try {
            log(`â³ æ­£åœ¨ä¸‹è½½æ–‡ä»¶ (ID: ${downloadId})...`);

            const response = await fetch(`${workerBaseUrl}/download/${downloadId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${userJwt}`
                }
            });

            if (!response.ok) {
                const error = await response.json();
                log(`âŒ ä¸‹è½½å¤±è´¥: ${error.msg || response.statusText}`);
                return;
            }

            // Get filename from Content-Disposition header or use downloadId
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = downloadId;
            if (contentDisposition) {
                const filenameMatch = contentDisposition.match(/filename="?(.+?)"?$/);
                if (filenameMatch && filenameMatch[1]) {
                    filename = filenameMatch[1];
                }
            }

            // Create download link and trigger click
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();

            // Clean up
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            log(`âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸ: ${filename}`);
        } catch (error) {
            log(`âŒ ä¸‹è½½è¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`);
        }
    });
</script>
</body>
</html>
